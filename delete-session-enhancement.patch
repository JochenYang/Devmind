## DevMind MCP - delete_session å·¥å…·å¢å¼ºè¡¥ä¸
## åŠŸèƒ½ï¼šæ”¯æŒé€šè¿‡ project_id åˆ é™¤æ•´ä¸ªé¡¹ç›® + æ”¹è¿› list_projects è¾“å‡º

### 1ï¸âƒ£ ä¿®æ”¹å·¥å…·å®šä¹‰ï¼ˆç²¾ç®€ç‰ˆæè¿°ï¼‰

æ–‡ä»¶ï¼šsrc/mcp-server.ts
ä½ç½®ï¼šL689-L702

```diff
         {
           name: "delete_session",
-          description:
-            "Delete a session and all its contexts (use with caution)",
+          description:
+            "Delete session(s) and contexts. Use session_id OR project_id (from list_projects).",
           inputSchema: {
             type: "object",
             properties: {
               session_id: {
                 type: "string",
-                description: "Session ID to delete",
+                description: "Session ID (from get_current_session)",
               },
+              project_id: {
+                type: "string",
+                description: "Delete ALL sessions of this project (from list_projects)",
+              },
             },
-            required: ["session_id"],
+            // ä¸éœ€è¦ requiredï¼Œå› ä¸ºäºŒé€‰ä¸€
           },
         },
```

---

### 2ï¸âƒ£ ä¿®æ”¹å¤„ç†é€»è¾‘

æ–‡ä»¶ï¼šsrc/mcp-server.ts
ä½ç½®ï¼šL864-L867 (handleDeleteSession è°ƒç”¨)

```diff
         case "delete_session":
           return await this.handleDeleteSession(
-            safeArgs as { session_id: string }
+            safeArgs as { session_id?: string; project_id?: string }
           );
```

---

### 3ï¸âƒ£ å¢å¼º handleDeleteSession æ–¹æ³•

æ–‡ä»¶ï¼šsrc/mcp-server.ts
ä½ç½®ï¼šæ‰¾åˆ° `private async handleDeleteSession` æ–¹æ³•

```typescript
private async handleDeleteSession(args: {
  session_id?: string;
  project_id?: string;
}) {
  try {
    // å‚æ•°éªŒè¯
    if (!args.session_id && !args.project_id) {
      return {
        content: [{
          type: "text",
          text: "Error: Provide either session_id or project_id",
        }],
        isError: true,
      };
    }

    if (args.session_id && args.project_id) {
      return {
        content: [{
          type: "text",
          text: "Error: Cannot provide both session_id and project_id",
        }],
        isError: true,
      };
    }

    // æ–°å¢ï¼šé€šè¿‡ project_id åˆ é™¤æ‰€æœ‰ä¼šè¯
    if (args.project_id) {
      const sessions = this.db.getSessionsByProject(args.project_id);

      if (sessions.length === 0) {
        return {
          content: [{
            type: "text",
            text: `No sessions found for project ${args.project_id}`,
          }],
          isError: false,
        };
      }

      let totalContexts = 0;
      for (const session of sessions) {
        const contexts = this.db.getContextsBySession(session.id);
        totalContexts += contexts.length;
        this.db.deleteSession(session.id);
      }

      return {
        content: [{
          type: "text",
          text:
            `âœ… Deleted project: ${args.project_id}\n` +
            `Sessions: ${sessions.length}\n` +
            `Contexts: ${totalContexts}\n` +
            `âš ï¸  Cannot be undone!`,
        }],
        isError: false,
      };
    }

    // åŸæœ‰é€»è¾‘ï¼šé€šè¿‡ session_id åˆ é™¤
    const session = this.db.getSession(args.session_id!);
    if (!session) {
      return {
        content: [{
          type: "text",
          text: `Session not found: ${args.session_id}`,
        }],
        isError: false,
      };
    }

    const contexts = this.db.getContextsBySession(args.session_id!);
    this.db.deleteSession(args.session_id!);

    return {
      content: [{
        type: "text",
        text:
          `âœ… Deleted session: ${args.session_id}\n` +
          `Name: ${session.name}\n` +
          `Contexts: ${contexts.length}\n` +
          `âš ï¸  Cannot be undone!`,
      }],
      isError: false,
    };
  } catch (error) {
    return {
      content: [{
        type: "text",
        text: `Failed to delete: ${
          error instanceof Error ? error.message : "Unknown error"
        }`,
      }],
      isError: true,
    };
  }
}
```

---

### 4ï¸âƒ£ æ”¹è¿› handleListProjects è¾“å‡º

æ–‡ä»¶ï¼šsrc/mcp-server.ts
ä½ç½®ï¼šæ‰¾åˆ° `private async handleListProjects` æ–¹æ³•ä¸­çš„è¾“å‡ºéƒ¨åˆ†

```diff
       const sessions = this.db.getProjectSessions(project.id);
       const contextsCount = this.db.getProjectContextsCount(project.id);
       const activeSessions = sessions.filter((s) => s.status === "active");
+      
+      // ğŸ†• è·å–ä¸»æ´»è·ƒä¼šè¯
+      const mainActiveSession = activeSessions.length > 0
+        ? activeSessions.sort((a, b) =>
+            new Date(b.started_at).getTime() - new Date(a.started_at).getTime()
+          )[0]
+        : null;

       // ... çœç•¥å…¶ä»–ä»£ç  ...

       return {
         id: project.id,
         name: project.name,
         path: project.path,
         language: project.language,
         framework: project.framework,
         stats: {
           total_sessions: sessions.length,
           active_sessions: activeSessions.length,
           total_contexts: contextsCount,
           last_activity: lastActivity,
           created_at: project.created_at,
+          main_active_session_id: mainActiveSession?.id, // ğŸ†•
         },
       };
```

---

### 5ï¸âƒ£ æ”¹è¿›è¾“å‡ºæ ¼å¼åŒ–

æ–‡ä»¶ï¼šsrc/mcp-server.ts
ä½ç½®ï¼š`handleListProjects` æ–¹æ³•çš„è¾“å‡ºæ ¼å¼åŒ–éƒ¨åˆ†

```diff
     projectsWithStats.forEach((project, index) => {
       outputLines.push(`${index + 1}. **${project.name}**`);
       outputLines.push(`   - Path: \`${project.path}\``);
-      outputLines.push(`   - ID: ${project.id}`);
+      outputLines.push(`   - Project ID: \`${project.id}\``); // ğŸ†• æ˜ç¡®æ ‡æ³¨

       if (project.language)
         outputLines.push(`   - Language: ${project.language}`);
       if (project.framework)
         outputLines.push(`   - Framework: ${project.framework}`);

       if (includeStats && "stats" in project && project.stats) {
         outputLines.push(`   - ğŸ“Š Statistics:`);
         outputLines.push(`     - Contexts: ${project.stats.total_contexts}`);
         outputLines.push(
-          `     - Sessions: ${project.stats.total_sessions} (${project.stats.active_sessions} active)`
+          `     - Sessions: ${project.stats.total_sessions} total (${project.stats.active_sessions} active)` // ğŸ†•
         );
+        
+        // ğŸ†• æ˜¾ç¤ºæ´»è·ƒä¼šè¯ID
+        if (project.stats.main_active_session_id) {
+          outputLines.push(
+            `     - Active Session: \`${project.stats.main_active_session_id}\``
+          );
+        }
+        
         outputLines.push(
           `     - Last Activity: ${new Date(
             project.stats.last_activity
           ).toLocaleString()}`
         );
+        
+        // ğŸ†• åˆ é™¤æç¤ºï¼ˆä»…å½“æœ‰è®°å¿†æ—¶æ˜¾ç¤ºï¼‰
+        if (project.stats.total_contexts > 0) {
+          outputLines.push(
+            `   - ğŸ—‘ï¸  To delete: \`delete_session({project_id: "${project.id}"})\``
+          );
+        }
       }
       outputLines.push("");
     });
```

---

## ğŸ“Š Token ä¼˜åŒ–è¯´æ˜

**å·¥å…·æè¿°é•¿åº¦å¯¹æ¯”ï¼š**

| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å | èŠ‚çœ |
|------|--------|--------|------|
| description | 61 å­—ç¬¦ | 78 å­—ç¬¦ | -17 å­—ç¬¦ |
| session_id desc | 21 å­—ç¬¦ | 37 å­—ç¬¦ | -16 å­—ç¬¦ |
| project_id desc | N/A | 65 å­—ç¬¦ | æ–°å¢ |
| **æ€»è®¡** | 82 å­—ç¬¦ | 180 å­—ç¬¦ | **+98 å­—ç¬¦** |

**æƒè¡¡ï¼š** è™½ç„¶å¢åŠ äº† ~100 å­—ç¬¦ï¼ˆçº¦ 25 tokensï¼‰ï¼Œä½†å¸¦æ¥äº†ï¼š
- âœ… æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
- âœ… å‡å°‘äº†ç”¨æˆ·çŠ¯é”™å’Œé‡è¯•æ¬¡æ•°ï¼ˆå®é™…èŠ‚çœæ›´å¤šå¯¹è¯ tokensï¼‰
- âœ… é¿å…äº†ç”¨æˆ·éœ€è¦é¢å¤–æŸ¥è¯¢ session_id çš„å¼€é”€

---

## ğŸ“¦ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆ é™¤æ•´ä¸ªé¡¹ç›®
```typescript
// ç”¨æˆ·æ‰§è¡Œ
list_projects()

// çœ‹åˆ°è¾“å‡º
1. **test**
   - Project ID: `fe26a3a1-...`
   - ğŸ—‘ï¸  To delete: `delete_session({project_id: "fe26a3a1-..."})`

// ç›´æ¥åˆ é™¤ï¼ˆæ–°åŠŸèƒ½ï¼‰
delete_session({project_id: "fe26a3a1-7075-47a7-bdf1-3ac4bc9b318e"})

// è¾“å‡º
âœ… Deleted project: fe26a3a1-7075-47a7-bdf1-3ac4bc9b318e
Sessions: 1
Contexts: 6
âš ï¸  Cannot be undone!
```

### ç¤ºä¾‹ 2ï¼šåˆ é™¤å•ä¸ªä¼šè¯ï¼ˆåŸæœ‰åŠŸèƒ½ï¼Œä¿æŒå…¼å®¹ï¼‰
```typescript
delete_session({session_id: "6b3dee69-95cd-44e0-ad38-764fa52bb874"})

// è¾“å‡º
âœ… Deleted session: 6b3dee69-95cd-44e0-ad38-764fa52bb874
Name: Auto-created session
Contexts: 129
âš ï¸  Cannot be undone!
```

---

## âœ… æµ‹è¯•æ¸…å•

- [ ] æµ‹è¯• `delete_session({project_id: "xxx"})` - åˆ é™¤æ•´ä¸ªé¡¹ç›®
- [ ] æµ‹è¯• `delete_session({session_id: "xxx"})` - å‘åå…¼å®¹
- [ ] æµ‹è¯•åŒæ—¶æä¾› session_id å’Œ project_id - æŠ¥é”™
- [ ] æµ‹è¯•ä¸æä¾›ä»»ä½•å‚æ•° - æŠ¥é”™
- [ ] æµ‹è¯•åˆ é™¤ä¸å­˜åœ¨çš„ project_id - å‹å¥½æç¤º
- [ ] éªŒè¯ `list_projects` è¾“å‡ºæ ¼å¼æ­£ç¡®
- [ ] éªŒè¯åˆ é™¤æç¤ºä»…åœ¨æœ‰è®°å¿†æ—¶æ˜¾ç¤º

---

## ğŸ“ CHANGELOG æ¡ç›®

```markdown
## [2.1.12] - 2025-11-19

### Enhanced
- **delete_session**: Now accepts `project_id` to delete all sessions of a project
- **list_projects**: Added `main_active_session_id` to output and deletion hints

### Improved
- Reduced user confusion when deleting duplicate projects
- Token-optimized tool descriptions for better context efficiency
```
